version: 3
projects:
- name: tf-atlantis-elk
  dir: ./terraform
  workflow: custom

workflows:
  custom:
    plan:
      steps:
      - env:
          name: GITHUB_USER
          command: 'kubectl get secret atlantis-github-secrets -o jsonpath="{.data.GITHUB_USER}" | base64 --decode'
      - env:
          name: GITHUB_TOKEN
          command: 'kubectl get secret atlantis-github-secrets -o jsonpath="{.data.GITHUB_TOKEN}" | base64 --decode'
      - env:
          name: GITHUB_SECRET
          command: 'kubectl get secret atlantis-github-secrets -o jsonpath="{.data.GITHUB_SECRET}" | base64 --decode'
      - env:
          name: KUBE_CONFIG_PATH
          value: "~/.kube/config"
      - init
      - plan

    apply:
      steps:
      - env:
          name: GITHUB_USER
          command: 'kubectl get secret atlantis-github-secrets -o jsonpath="{.data.GITHUB_USER}" | base64 --decode'
      - env:
          name: GITHUB_TOKEN
          command: 'kubectl get secret atlantis-github-secrets -o jsonpath="{.data.GITHUB_TOKEN}" | base64 --decode'
      - env:
          name: GITHUB_SECRET
          command: 'kubectl get secret atlantis-github-secrets -o jsonpath="{.data.GITHUB_SECRET}" | base64 --decode'
      - env:
          name: KUBE_CONFIG_PATH
          value: "~/.kube/config"
      - apply
