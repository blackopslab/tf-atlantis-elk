version: 3

workflows:
  default:
    plan:
      steps:
        - run: |
            GITHUB_USER=$(kubectl get secret atlantis-github-secrets -o jsonpath='{.data.GITHUB_USER}' | base64 --decode)
            GITHUB_TOKEN=$(kubectl get secret atlantis-github-secrets -o jsonpath='{.data.GITHUB_TOKEN}' | base64 --decode)
            GITHUB_SECRET=$(kubectl get secret atlantis-github-secrets -o jsonpath='{.data.GITHUB_SECRET}' | base64 --decode)
            terraform plan -var "github_user=$GITHUB_USER" -var "github_token=$GITHUB_TOKEN" -var "github_secret=$GITHUB_SECRET"
          dir: terraform/
    apply:
      steps:
        - run: |
            GITHUB_USER=$(kubectl get secret atlantis-github-secrets -o jsonpath='{.data.GITHUB_USER}' | base64 --decode)
            GITHUB_TOKEN=$(kubectl get secret atlantis-github-secrets -o jsonpath='{.data.GITHUB_TOKEN}' | base64 --decode)
            GITHUB_SECRET=$(kubectl get secret atlantis-github-secrets -o jsonpath='{.data.GITHUB_SECRET}' | base64 --decode)
            terraform apply -var "github_user=$GITHUB_USER" -var "github_token=$GITHUB_TOKEN" -var "github_secret=$GITHUB_SECRET"
          dir: terraform/
